#!/bin/bash

# Git hook для автоматического деплоя без прерывания работы сайта
# Разместить в: /var/www/tg-text.ru/.git/hooks/post-receive

set -e

DOMAIN="tg-text.ru"
WWW_ROOT="/var/www/${DOMAIN}"
DEPLOY_DIR="${WWW_ROOT}/public_html"
STAGING_DIR="${WWW_ROOT}/staging"
NGINX_USER="www-data"
GIT_DIR="${WWW_ROOT}/.git"

echo "=== Начало деплоя ==="
date

# Читаем данные из stdin (стандартный ввод Git hook)
while read oldrev newrev refname; do
    branch=$(git rev-parse --symbolic --abbrev-ref $refname 2>/dev/null || echo "main")
    echo "Обновление ветки: $branch (ref: $refname)"
done

# Создаем staging директорию
mkdir -p ${STAGING_DIR}

# Делаем checkout в staging директорию
cd ${WWW_ROOT}
export GIT_DIR=${GIT_DIR}
export GIT_WORK_TREE=${STAGING_DIR}
git checkout -f main 2>/dev/null || git checkout -f
unset GIT_DIR
unset GIT_WORK_TREE

# Сборка React приложения на сервере
echo "Сборка React приложения..."
cd ${STAGING_DIR}

if [ -f "package.json" ]; then
    # Проверяем наличие Node.js и npm
    if ! command -v npm &> /dev/null; then
        echo "ОШИБКА: npm не установлен на сервере!"
        exit 1
    fi
    
    # Устанавливаем зависимости если нужно
    if [ ! -d "node_modules" ]; then
        echo "Установка зависимостей..."
        npm install --production=false
    fi
    
    # Собираем React приложение
    echo "Запуск сборки..."
    npm run build
    
    if [ $? -ne 0 ]; then
        echo "ОШИБКА: Сборка не удалась!"
        exit 1
    fi
    
    echo "Сборка завершена успешно."
    
    # Копируем собранные файлы из dist в public_html
    if [ -d "dist" ]; then
        echo "Копирование собранных файлов из dist..."
        mkdir -p ${DEPLOY_DIR}
        rm -rf ${DEPLOY_DIR}/*
        cp -r ${STAGING_DIR}/dist/* ${DEPLOY_DIR}/
        echo "Проверка index.html после копирования..."
        if ! grep -q "/assets/" ${DEPLOY_DIR}/index.html 2>/dev/null; then
            echo "ОШИБКА: index.html не содержит ссылок на /assets/ - пересобираем..."
            # Пересобираем если что-то пошло не так
            npm run build
            rm -rf ${DEPLOY_DIR}/*
            cp -r ${STAGING_DIR}/dist/* ${DEPLOY_DIR}/
        fi
        echo "Проверка файлов в public_html..."
        ls -la ${DEPLOY_DIR}/assets/ 2>/dev/null || echo "ПРЕДУПРЕЖДЕНИЕ: папка assets не найдена!"
    else
        echo "ОШИБКА: Папка dist не найдена после сборки!"
        exit 1
    fi
else
    echo "Предупреждение: package.json не найден, используем старые файлы"
    
    # Проверяем наличие index.html
    if [ ! -f "${STAGING_DIR}/index.html" ]; then
        echo "ОШИБКА: index.html не найден в репозитории!"
        exit 1
    fi
    
    # Копируем только файлы сайта из staging в production атомарно
    echo "Копирование файлов сайта..."
    rsync -av --delete \
      --include='index.html' \
      --include='*.html' \
      --include='*.css' \
      --include='*.js' \
      --include='*.jpg' \
      --include='*.jpeg' \
      --include='*.png' \
      --include='*.gif' \
      --include='*.svg' \
      --include='*.ico' \
      --include='*.woff' \
      --include='*.woff2' \
      --include='*.ttf' \
      --include='*.eot' \
      --exclude='deploy.ps1' \
      --exclude='nginx_*.conf' \
      --exclude='post-receive' \
      --exclude='README.md' \
      --exclude='DEPLOY_GUIDE.md' \
      --exclude='SSL/' \
      --exclude='*.sh' \
      ${STAGING_DIR}/ ${DEPLOY_DIR}/ || \
      (cp ${STAGING_DIR}/index.html ${DEPLOY_DIR}/ 2>/dev/null || true)
fi

# Копируем служебные файлы (.sh, .sql) в корень репозитория (не в public_html)
echo "Копирование служебных файлов..."
if [ -f "${STAGING_DIR}/setup_mysql.sh" ]; then
    cp ${STAGING_DIR}/setup_mysql.sh ${WWW_ROOT}/
    chmod +x ${WWW_ROOT}/setup_mysql.sh
fi
if [ -f "${STAGING_DIR}/init_database.sql" ]; then
    cp ${STAGING_DIR}/init_database.sql ${WWW_ROOT}/
fi

# Директория API (app.js, bot.js, сервисы text-processor и telegram-bot)
API_DIR="${WWW_ROOT}/api"
mkdir -p ${API_DIR}

# Копируем app.js и bot.js в API
if [ -f "${STAGING_DIR}/app.js" ]; then
    cp ${STAGING_DIR}/app.js ${API_DIR}/
    echo "app.js скопирован в ${API_DIR}/"
fi
if [ -f "${STAGING_DIR}/bot.js" ]; then
    cp ${STAGING_DIR}/bot.js ${API_DIR}/
    echo "bot.js скопирован в ${API_DIR}/"
fi

# Зависимости API (для app.js и bot.js)
if [ -f "${STAGING_DIR}/package.json" ]; then
    cp ${STAGING_DIR}/package.json ${API_DIR}/
    cd ${API_DIR}
    if [ ! -d "node_modules" ] && command -v npm &> /dev/null; then
        echo "Установка зависимостей для API..."
        npm install --production 2>&1 | tail -5
    fi
    if ! npm list node-telegram-bot-api &>/dev/null; then
        npm install node-telegram-bot-api 2>&1 | tail -3
    fi
    cd ${STAGING_DIR}
fi

# Миграция БД: prompt_template и request_count (если ещё нет — иначе ошибку игнорируем)
if [ -f "${STAGING_DIR}/migrations/add_prompt_and_count.sql" ]; then
    echo "Проверка миграции БД (prompt_template, request_count)..."
    mysql -u tg_text_user -ptg_text_password_2024 tg_text_db < "${STAGING_DIR}/migrations/add_prompt_and_count.sql" 2>/dev/null || true
fi

# Копируем unit-файлы systemd и перезапускаем сервисы
if [ -f "${STAGING_DIR}/text-processor.service" ]; then
    cp ${STAGING_DIR}/text-processor.service /etc/systemd/system/
    echo "text-processor.service обновлён"
fi
if [ -f "${STAGING_DIR}/telegram-bot.service" ]; then
    cp ${STAGING_DIR}/telegram-bot.service /etc/systemd/system/
    echo "telegram-bot.service обновлён"
fi
systemctl daemon-reload 2>/dev/null || true
echo "Перезапуск сервиса text-processor..."
systemctl restart text-processor 2>&1 || true
if systemctl is-enabled telegram-bot &>/dev/null; then
    echo "Перезапуск сервиса telegram-bot..."
    systemctl restart telegram-bot 2>&1 || true
fi
sleep 2
systemctl status text-processor --no-pager | head -5

# Копируем конфигурацию nginx
if [ -f "${STAGING_DIR}/nginx_tg-text.ru.conf" ]; then
    echo "Копирование конфигурации nginx..."
    cp ${STAGING_DIR}/nginx_tg-text.ru.conf /etc/nginx/conf.d/tg-text.ru.conf
    echo "Конфигурация nginx обновлена"
fi

# Права: nginx (www-data) должен читать файлы и проходить по каталогам
# Родительские каталоги — доступ на выполнение (traverse) для всех
chmod o+rx "${WWW_ROOT}" 2>/dev/null || true
chmod o+rx /var/www 2>/dev/null || true
chown -R ${NGINX_USER}:${NGINX_USER} ${DEPLOY_DIR}
find ${DEPLOY_DIR} -type d -exec chmod 755 {} \;
find ${DEPLOY_DIR} -type f -exec chmod 644 {} \;

# Проверяем конфигурацию nginx
echo "Проверка конфигурации nginx..."
if nginx -t; then
    # Перезагружаем nginx (graceful reload - без прерывания работы)
    echo "Перезагрузка nginx..."
    systemctl reload nginx
    echo "Nginx перезагружен успешно"
else
    echo "ОШИБКА: Конфигурация nginx неверна! Nginx не перезагружен."
    exit 1
fi

# Обновляем сам hook post-receive из репозитория (чтобы следующий деплой использовал актуальную версию)
if [ -f "${STAGING_DIR}/post-receive" ]; then
    cp "${STAGING_DIR}/post-receive" "${GIT_DIR}/hooks/post-receive"
    chmod +x "${GIT_DIR}/hooks/post-receive"
    echo "post-receive hook обновлён"
fi

# Очищаем staging директорию
rm -rf ${STAGING_DIR}

echo "=== Деплой завершен успешно ==="
date

