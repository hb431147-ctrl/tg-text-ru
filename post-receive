#!/bin/bash

# Git hook для автоматического деплоя без прерывания работы сайта
# Разместить в: /var/www/tg-text.ru/.git/hooks/post-receive

set -e

DOMAIN="tg-text.ru"
WWW_ROOT="/var/www/${DOMAIN}"
DEPLOY_DIR="${WWW_ROOT}/public_html"
STAGING_DIR="${WWW_ROOT}/staging"
NGINX_USER="www-data"
GIT_DIR="${WWW_ROOT}/.git"

echo "=== Начало деплоя ==="
date

# Читаем данные из stdin (стандартный ввод Git hook)
while read oldrev newrev refname; do
    branch=$(git rev-parse --symbolic --abbrev-ref $refname 2>/dev/null || echo "main")
    echo "Обновление ветки: $branch (ref: $refname)"
done

# Создаем staging директорию
mkdir -p ${STAGING_DIR}

# Делаем checkout в staging директорию
cd ${WWW_ROOT}
export GIT_DIR=${GIT_DIR}
export GIT_WORK_TREE=${STAGING_DIR}
git checkout -f main 2>/dev/null || git checkout -f
unset GIT_DIR
unset GIT_WORK_TREE

# Проверяем наличие index.html
if [ ! -f "${STAGING_DIR}/index.html" ]; then
    echo "ОШИБКА: index.html не найден в репозитории!"
    exit 1
fi

# Копируем только файлы сайта из staging в production атомарно
echo "Копирование файлов сайта..."
# Копируем только index.html и другие файлы сайта (HTML, CSS, JS, изображения)
# Исключаем служебные файлы: deploy.ps1, nginx_*.conf, post-receive, README.md, DEPLOY_GUIDE.md, SSL/
rsync -av --delete \
  --include='index.html' \
  --include='*.html' \
  --include='*.css' \
  --include='*.js' \
  --include='*.jpg' \
  --include='*.jpeg' \
  --include='*.png' \
  --include='*.gif' \
  --include='*.svg' \
  --include='*.ico' \
  --include='*.woff' \
  --include='*.woff2' \
  --include='*.ttf' \
  --include='*.eot' \
  --exclude='deploy.ps1' \
  --exclude='nginx_*.conf' \
  --exclude='post-receive' \
  --exclude='README.md' \
  --exclude='DEPLOY_GUIDE.md' \
  --exclude='SSL/' \
  --exclude='*.sh' \
  ${STAGING_DIR}/ ${DEPLOY_DIR}/ || \
  (cp ${STAGING_DIR}/index.html ${DEPLOY_DIR}/ 2>/dev/null || true)

# Копируем служебные файлы (.sh, .sql) в корень репозитория (не в public_html)
echo "Копирование служебных файлов..."
if [ -f "${STAGING_DIR}/setup_mysql.sh" ]; then
    cp ${STAGING_DIR}/setup_mysql.sh ${WWW_ROOT}/
    chmod +x ${WWW_ROOT}/setup_mysql.sh
fi
if [ -f "${STAGING_DIR}/init_database.sql" ]; then
    cp ${STAGING_DIR}/init_database.sql ${WWW_ROOT}/
fi
if [ -f "${STAGING_DIR}/app.js" ]; then
    cp ${STAGING_DIR}/app.js ${WWW_ROOT}/
fi
if [ -f "${STAGING_DIR}/package.json" ]; then
    cp ${STAGING_DIR}/package.json ${WWW_ROOT}/
fi

# Устанавливаем правильные права
chown -R ${NGINX_USER}:${NGINX_USER} ${DEPLOY_DIR}
chmod -R 755 ${DEPLOY_DIR}

# Проверяем конфигурацию nginx
echo "Проверка конфигурации nginx..."
nginx -t

# Перезагружаем nginx (graceful reload - без прерывания работы)
echo "Перезагрузка nginx..."
systemctl reload nginx

# Очищаем staging директорию
rm -rf ${STAGING_DIR}

echo "=== Деплой завершен успешно ==="
date

